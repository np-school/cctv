<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard เจ้าหน้าที่ | ฝ่ายกิจการนักเรียน</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; color: #334155; }
        .glass-header { background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(8px); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .loader-big { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #1e3a8a; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="glass-header text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-shield-halved text-yellow-400 text-xl"></i>
                <h1 class="font-bold text-lg md:text-xl">ระบบจัดการสำหรับเจ้าหน้าที่</h1>
            </div>
            <!-- แก้ไขลิงก์กลับหน้าหลักให้เป็น index.html -->
            <a href="index.html" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-sm transition-all flex items-center gap-2 font-bold">
                <i class="fa-solid fa-arrow-left"></i> <span>กลับหน้าหลัก</span>
            </a>
        </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 md:p-8">
        <!-- Dashboard Summary -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="text-blue-600 mb-2"><i class="fa-solid fa-list-check text-2xl"></i></div>
                <div class="text-2xl font-black text-slate-800" id="totalCount">0</div>
                <div class="text-xs font-bold text-slate-400 uppercase">คำร้องทั้งหมด</div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="text-amber-500 mb-2"><i class="fa-solid fa-clock text-2xl"></i></div>
                <div class="text-2xl font-black text-slate-800" id="todayCount">0</div>
                <div class="text-xs font-bold text-slate-400 uppercase">คำร้องวันนี้</div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="text-green-600 mb-2"><i class="fa-solid fa-signal text-2xl"></i></div>
                <div class="text-2xl font-black text-slate-800" id="statusLabel">Online</div>
                <div class="text-xs font-bold text-slate-400 uppercase">สถานะระบบ</div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="text-indigo-600 mb-2"><i class="fa-solid fa-calendar-day text-2xl"></i></div>
                <div class="text-sm font-bold text-slate-800" id="currentDateDisplay">...</div>
                <div class="text-xs font-bold text-slate-400 uppercase">วันที่ปัจจุบัน</div>
            </div>
        </div>

        <!-- Table Content -->
        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-table-list text-blue-600"></i> รายการคำขอดูกล้องวงจรปิด
                </h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="text" id="searchInput" placeholder="ค้นหาชื่อหรือเลขที่..." class="flex-grow md:w-64 border border-slate-200 p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="fetchAdminData()" class="bg-blue-900 text-white p-2 px-4 rounded-xl hover:bg-blue-800 transition-all text-sm font-bold flex items-center gap-2">
                        <i class="fa-solid fa-sync-alt"></i> <span>รีเฟรช</span>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b">
                        <tr>
                            <th class="px-6 py-4">ID</th>
                            <th class="px-6 py-4">ผู้แจ้งเหตุ</th>
                            <th class="px-6 py-4">ตำแหน่ง/ชั้น</th>
                            <th class="px-6 py-4">วันที่แจ้ง</th>
                            <th class="px-6 py-4">เป้าหมายตรวจ</th>
                            <th class="px-6 py-4">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="6" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="loader-big"></div>
                                    <p class="text-slate-400 font-medium">กำลังโหลดข้อมูลจาก Google Sheets...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxYxjZzOYpmsOC4mizwfagtVuUbgMLTPwuZ_aw_tfVDHIjVXOCQ5uS8K9zECDs1cUra2w/exec'; 
        let allData = [];

        function formatDate(isoString) {
            if(!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });
        }

        function formatSimpleDate(isoString) {
            if(!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        async function fetchAdminData() {
            const tableBody = document.getElementById('dataTableBody');
            
            if (!scriptURL || scriptURL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                allData = [
                    { requestId: 'NP0001', submissionDate: new Date(), fullName: 'ตัวอย่าง สมชาย', position: 'ม.1/2', targetDate: '2023-10-25', details: 'ทำกระเป๋าตังค์หายแถวหน้าเสาธง' },
                    { requestId: 'NP0002', submissionDate: new Date(), fullName: 'สมศรี มีดี', position: 'ม.5/4', targetDate: '2023-10-24', details: 'รถจักรยานยนต์โดนเฉี่ยวชนที่โรงจอด' }
                ];
                renderTable(allData);
                updateStats(allData);
                return;
            }

            try {
                const response = await fetch(`${scriptURL}?action=getAll&t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.result === 'success') {
                    allData = data.data;
                    renderTable(allData);
                    updateStats(allData);
                }
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-red-500">ไม่สามารถเชื่อมต่อข้อมูลได้ กรุณาตรวจสอบ Apps Script</td></tr>`;
                document.getElementById('statusLabel').innerText = "Error";
                document.getElementById('statusLabel').className = "text-2xl font-black text-red-600";
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('dataTableBody');
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">ไม่พบข้อมูลคำร้อง</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => `
                <tr class="border-b hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-mono font-bold text-blue-700">${item.requestId || '-'}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">${item.fullName || '-'}</td>
                    <td class="px-6 py-4">${item.position || '-'}</td>
                    <td class="px-6 py-4 text-xs text-slate-500">${formatDate(item.submissionDate)}</td>
                    <td class="px-6 py-4 font-bold text-blue-600">${formatSimpleDate(item.targetDate)}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${item.details}">${item.details || '-'}</td>
                </tr>
            `).join('');
        }

        function updateStats(data) {
            document.getElementById('totalCount').innerText = data.length;
            const todayStr = new Date().toLocaleDateString();
            const todayCount = data.filter(item => new Date(item.submissionDate).toLocaleDateString() === todayStr).length;
            document.getElementById('todayCount').innerText = todayCount;
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.filter(item => 
                (item.fullName && item.fullName.toLowerCase().includes(term)) || 
                (item.requestId && item.requestId.toLowerCase().includes(term)) ||
                (item.position && item.position.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

        window.onload = () => {
            document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('th-TH', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
            fetchAdminData();
        };
    </script>
</body>
</html>
