<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฝ่ายกิจการนักเรียน | โรงเรียนหนองกี่พิทยาคม จ.บุรีรัมย์</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
            scroll-behavior: smooth; 
        }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin: auto; 
            height: 300px; 
        }
        @media (min-width: 768px) { 
            .chart-container { height: 400px; } 
        }
        .glass-nav { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(226, 232, 240, 0.8); 
        }
        .roster-item {
            transition: all 0.3s ease;
        }
        .roster-item.inactive { 
            filter: grayscale(1); 
            opacity: 0.6; 
        }
        .roster-item.active { 
            transform: scale(1.02); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            border-width: 2px; 
            border-color: #1e3a8a;
            background-color: #ffffff; 
        }
        .loader { 
            border: 3px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff; 
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="http://www.nongki.ac.th/np/images/logo_np.gif" alt="Logo" class="w-12 h-12 object-contain" onerror="this.src='https://via.placeholder.com/48'">
                <div class="flex flex-col">
                    <span class="text-lg font-bold text-slate-800 leading-none">ฝ่ายกิจการนักเรียน</span>
                    <span class="text-xs text-slate-500 font-medium">โรงเรียนหนองกี่พิทยาคม</span>
                </div>
            </div>
            <button onclick="openModal()" class="bg-blue-900 hover:bg-blue-800 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-md flex items-center gap-2 transition-all active:scale-95">
                <i class="fa-solid fa-plus-circle"></i> <span>แจ้งเหตุ/ขอดูกล้อง</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow pt-28 pb-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto mb-10 text-center">
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight">ระบบบริหารจัดการ <span class="text-blue-700">ฝ่ายกิจการนักเรียน</span></h1>
            <p class="text-slate-600 max-w-2xl mx-auto">ติดตามสถิติและยื่นคำร้องขอดูกล้องวงจรปิดออนไลน์ ข้อมูลอ้างอิงจากฐานข้อมูลกลาง Google Sheets</p>
        </div>

        <div class="max-w-7xl mx-auto grid lg:grid-cols-3 gap-8">
            <!-- Analytics Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-blue-600"></i> สถิติการแจ้งเหตุ (Real-time)
                        </h2>
                        <div class="flex items-center gap-2">
                            <span id="syncStatus" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 uppercase">Checking...</span>
                            <button onclick="refreshData()" class="bg-slate-50 hover:bg-slate-100 text-blue-600 p-2 rounded-full transition-colors" title="รีเฟรชข้อมูล">
                                <i class="fa-solid fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container flex-grow" id="chartWrapper">
                        <canvas id="dailyRequestsChart"></canvas>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-50">
                        <p class="text-xs text-slate-400 italic text-center">หมายเหตุ: ข้อมูลอัปเดตอัตโนมัติเมื่อมีการแจ้งเหตุใหม่</p>
                    </div>
                </div>
            </div>

            <!-- Roster Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-3xl border border-slate-200 p-6 h-full shadow-sm">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 border-b pb-4"><i class="fa-solid fa-user-shield text-blue-600 mr-2"></i>ครูเวรประจำวัน</h2>
                    <div class="space-y-3" id="roster-list">
                        <!-- Monday -->
                        <div id="day-1" class="roster-item p-4 rounded-2xl border border-yellow-200 bg-yellow-50 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-yellow-400 text-white flex items-center justify-center font-bold shadow-sm">จ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายธนวิน เกิดประโคน</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>094-356-5879</p>
                            </div>
                        </div>
                        <!-- Tuesday -->
                        <div id="day-2" class="roster-item p-4 rounded-2xl border border-pink-200 bg-pink-50 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-pink-400 text-white flex items-center justify-center font-bold shadow-sm">อ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายธนวิน เกิดประโคน</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>094-356-5879</p>
                            </div>
                        </div>
                        <!-- Wednesday -->
                        <div id="day-3" class="roster-item p-4 rounded-2xl border border-green-200 bg-green-50 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center font-bold shadow-sm">พ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนัตพล ชะเมรัมย์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>065-390-4151</p>
                            </div>
                        </div>
                        <!-- Thursday -->
                        <div id="day-4" class="roster-item p-4 rounded-2xl border border-orange-200 bg-orange-50 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold shadow-sm">พฤ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนัตพล ชะเมรัมย์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>065-390-4151</p>
                            </div>
                        </div>
                        <!-- Friday -->
                        <div id="day-5" class="roster-item p-4 rounded-2xl border border-blue-200 bg-blue-50 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold shadow-sm">ศ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนราศักดิ์ เสาวยงค์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>088-696-3536</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Form -->
    <div id="requestModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <div class="relative bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all">
                <div class="bg-blue-900 px-6 py-5 flex justify-between items-center text-white">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-file-circle-plus text-xl text-yellow-400"></i>
                        <h3 class="font-bold text-lg">แบบฟอร์มแจ้งเหตุ / ขอดูกล้องวงจรปิด</h3>
                    </div>
                    <button onclick="closeModal()" class="hover:bg-blue-800 p-1 rounded-full transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="p-6 md:p-8 bg-slate-50">
                    <form id="cctvForm" class="space-y-5">
                        <input type="hidden" name="requestId" id="requestIdInput">
                        <input type="hidden" name="submissionDate" id="submissionDateInput">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">ชื่อ-นามสกุล ผู้แจ้ง</label>
                                <input type="text" name="fullName" required placeholder="เช่น นายสมชาย ใจดี" class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">ชั้น / ตำแหน่ง</label>
                                <input type="text" name="position" required placeholder="เช่น ม.6/1 หรือ ครูหัวหน้าฝ่าย" class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">เบอร์โทรศัพท์ติดต่อ</label>
                                <input type="tel" name="phone" required placeholder="08x-xxx-xxxx" class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">วันที่ต้องการตรวจสอบ</label>
                                <input type="date" name="targetDate" required class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 ml-1">รายละเอียดเหตุการณ์ / จุดที่ขอดู</label>
                            <textarea name="details" rows="4" required placeholder="อธิบายลักษณะเหตุการณ์ ช่วงเวลา และจุดพิกัดที่ต้องการตรวจสอบ..." class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex gap-3 items-start">
                            <i class="fa-solid fa-circle-info text-blue-600 mt-1"></i>
                            <p class="text-[11px] text-blue-800 leading-relaxed">
                                การส่งข้อมูลนี้ถือว่าผู้แจ้งยอมรับในระเบียบการขอดูกล้องวงจรปิดของโรงเรียน และข้อมูลจะถูกจัดเก็บเข้าสู่ระบบฐานข้อมูลกลางเพื่อประมวลผลสถิติและดำเนินการในลำดับถัดไป
                            </p>
                        </div>

                        <button type="submit" id="submitBtn" class="w-full bg-blue-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-blue-800 active:scale-[0.98] transition-all shadow-xl shadow-blue-900/20">
                            <span id="btnLoader" class="loader hidden"></span>
                            <span id="btnText">ยืนยันการส่งคำร้อง</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * สำคัญ: นำ URL ที่ได้จากขั้นตอน Deploy เป็น Web App ใน Apps Script มาใส่ที่นี่
         * URL จะมีลักษณะคล้าย https://script.google.com/macros/s/.../exec
         */
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwqGoXNxSWr_JD42gSp0lnVaLTqvYhr4REOuarhhpxtXjGnqlG6Nx-40LnEy4u1AaVNAA/exec'; 
        let myChart;

        // ฟังก์ชันดึงข้อมูลจาก Google Sheets (GET)
        async function refreshData() {
            const statusLabel = document.getElementById('syncStatus');
            statusLabel.innerText = "Syncing...";
            statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-blue-100 text-blue-600 uppercase animate-pulse";

            if (!scriptURL || scriptURL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                console.warn('Script URL is not set. Showing mock data.');
                renderChart(['15 ก.พ.', '16 ก.พ.', '17 ก.พ.'], [2, 5, 3]);
                statusLabel.innerText = "Mock Mode";
                statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-amber-100 text-amber-600 uppercase";
                return;
            }

            try {
                // เรียก API ที่เป็น doGet ใน Apps Script
                const response = await fetch(scriptURL);
                const data = await response.json();
                
                if (data.result === 'success') {
                    renderChart(data.labels, data.values);
                    statusLabel.innerText = "Connected";
                    statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-green-100 text-green-600 uppercase";
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (err) {
                console.error('Error fetching stats:', err);
                statusLabel.innerText = "Sync Failed";
                statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-red-100 text-red-600 uppercase";
                // แสดงข้อมูลจำลองถ้าโหลดไม่สำเร็จ
                renderChart(['Jan', 'Feb', 'Mar'], [0, 0, 0]);
            }
        }

        // ฟังก์ชันวาดกราฟสถิติ
        function renderChart(labels, values) {
            const ctx = document.getElementById('dailyRequestsChart').getContext('2d');
            
            // ลบกราฟเดิมถ้ามีอยู่แล้ว
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length ? labels : ['ไม่มีข้อมูล'],
                    datasets: [{
                        label: 'จำนวนเรื่องที่แจ้ง',
                        data: values.length ? values : [0],
                        backgroundColor: 'rgba(30, 58, 138, 0.85)',
                        hoverBackgroundColor: '#1e3a8a',
                        borderRadius: 12,
                        borderSkipped: false,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            displayColors: false,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { 
                                stepSize: 1,
                                font: { size: 11 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                font: { size: 11, weight: '500' }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // ฟังก์ชันสุ่มรหัสอ้างอิงและบันทึกใน LocalStorage
        function generateId() {
            const storageKey = 'last_np_req_id';
            const lastId = localStorage.getItem(storageKey) || 0;
            const newId = parseInt(lastId) + 1;
            localStorage.setItem(storageKey, newId);
            return 'NP' + String(newId).padStart(4, '0');
        }

        // เปิด/ปิด Modal
        function openModal() {
            document.getElementById('requestModal').classList.remove('hidden');
            document.getElementById('requestIdInput').value = generateId();
            document.getElementById('submissionDateInput').value = new Date().toISOString();
            document.body.style.overflow = 'hidden'; // กันเลื่อนหน้าหลัง
        }

        function closeModal() {
            document.getElementById('requestModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('cctvForm').reset();
        }

        // การส่งฟอร์ม (POST)
        document.getElementById('cctvForm').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const loader = document.getElementById('btnLoader');
            const text = document.getElementById('btnText');

            if (!scriptURL || scriptURL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                alert('กรุณาตั้งค่า Script URL ในโค้ด (บรรทัดที่ 216) ก่อนใช้งานการบันทึกข้อมูลครับ');
                return;
            }

            // UI Feedback
            btn.disabled = true;
            loader.classList.remove('hidden');
            text.innerText = "กำลังเชื่อมต่อกับ Sheets...";

            try {
                // ส่งข้อมูลแบบ POST
                const response = await fetch(scriptURL, { 
                    method: 'POST', 
                    body: new FormData(e.target) 
                });
                
                const result = await response.json();

                if (result.result === 'success') {
                    alert('บันทึกคำร้องสำเร็จ! ข้อมูลถูกจัดเก็บลงระบบเรียบร้อยแล้ว');
                    closeModal();
                    // อัปเดตกราฟทันทีหลังส่งข้อมูล
                    setTimeout(refreshData, 1000); 
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                console.error('Submission error:', err);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + err.message);
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
                text.innerText = "ยืนยันการส่งคำร้อง";
            }
        });

        // จัดการไฮไลท์ครูเวรตามวันจริง
        function updateRosterHighlight() {
            const today = new Date().getDay(); // 0=Sun, 1=Mon...
            document.querySelectorAll('.roster-item').forEach(item => {
                const dayId = item.id.split('-')[1];
                if (parseInt(dayId) === today) {
                    item.classList.add('active');
                } else {
                    item.classList.add('inactive');
                }
            });
        }

        // เริ่มต้นการทำงานเมื่อหน้าโหลดเสร็จ
        window.onload = () => {
            updateRosterHighlight();
            refreshData();
        };
    </script>
</body>
</html>


