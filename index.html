<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฝ่ายกิจการนักเรียน | โรงเรียนหนองกี่พิทยาคม จ.บุรีรัมย์</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
            scroll-behavior: smooth; 
        }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin: auto; 
            height: 300px; 
        }
        @media (min-width: 768px) { 
            .chart-container { height: 400px; } 
        }
        .glass-nav { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(226, 232, 240, 0.8); 
        }
        
        /* Roster Styles */
        .roster-item {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-width: 1px;
        }
        .roster-item.inactive { 
            filter: grayscale(1); 
            opacity: 0.5; 
            background-color: #f1f5f9;
            border-color: #e2e8f0;
        }
        .roster-item.inactive .day-icon {
            background-color: #94a3b8;
        }
        .roster-item.active { 
            transform: scale(1.03); 
            box-shadow: 0 10px 15px -3px rgba(30, 58, 138, 0.1); 
            border-width: 2px;
            background-color: #ffffff;
            z-index: 10;
        }
        
        .loader { 
            border: 3px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff; 
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .step-card {
            transition: transform 0.3s ease;
        }
        .step-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://nongki.ac.th/np2019/img/home/logo_np.gif" alt="Logo โรงเรียนหนองกี่พิทยาคม" class="w-12 h-12 object-contain" onerror="this.onerror=null; this.src='https://via.placeholder.com/48?text=NP';">
                <div class="flex flex-col">
                    <span class="text-lg font-bold text-slate-800 leading-none">ฝ่ายกิจการนักเรียน</span>
                    <span class="text-xs text-slate-500 font-medium">โรงเรียนหนองกี่พิทยาคม</span>
                </div>
            </div>
            
            <!-- Desktop Menu -->
            <div class="flex items-center gap-4">
                <a href="admin.html" class="hidden md:flex items-center gap-2 text-slate-600 hover:text-blue-900 font-bold text-sm px-4 py-2 rounded-xl hover:bg-slate-100 transition-all">
                    <i class="fa-solid fa-user-shield"></i>
                    <span>สำหรับเจ้าหน้าที่</span>
                </a>
                <button onclick="openModal()" class="bg-blue-900 hover:bg-blue-800 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-md flex items-center gap-2 transition-all active:scale-95">
                    <i class="fa-solid fa-plus-circle"></i> <span>แจ้งเหตุ/ขอดูกล้อง</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow pt-28 pb-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto mb-12 text-center">
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight">ระบบบริหารจัดการ <span class="text-blue-700">ฝ่ายกิจการนักเรียน</span></h1>
            <p class="text-slate-600 max-w-3xl mx-auto text-sm md:text-base leading-relaxed mb-10">
                โรงเรียนหนองกี่พิทยาคมมุ่งเน้นความปลอดภัยของนักเรียนและบุคลากร โดยติดตั้งระบบกล้องวงจรปิดครอบคลุมพื้นที่อาคารเรียน สนามกีฬา และจุดเสี่ยงทั่วบริเวณโรงเรียน 
                เพื่อการตรวจสอบเหตุการณ์และรักษาความปลอดภัยอย่างมีประสิทธิภาพตลอด 24 ชั่วโมง
            </p>

            <!-- Info Steps Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                <!-- Step 1 -->
                <div class="step-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm relative overflow-hidden group">
                    <div class="absolute -top-2 -right-2 w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-200 font-black text-4xl group-hover:text-blue-100 transition-colors">1</div>
                    <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-lg shadow-blue-200">
                        <i class="fa-solid fa-pen-to-square text-lg"></i>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-2">ยื่นคำร้องออนไลน์</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">กรอกข้อมูลรายละเอียดเหตุการณ์และจุดประสงค์การตรวจสอบผ่านระบบคำร้องออนไลน์</p>
                </div>
                <!-- Step 2 -->
                <div class="step-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm relative overflow-hidden group">
                    <div class="absolute -top-2 -right-2 w-16 h-16 bg-green-50 rounded-full flex items-center justify-center text-green-200 font-black text-4xl group-hover:text-green-100 transition-colors">2</div>
                    <div class="w-12 h-12 bg-green-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-lg shadow-green-200">
                        <i class="fa-solid fa-phone-volume text-lg"></i>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-2">ประสานงานเจ้าหน้าที่</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">ติดต่อประสานงานครูเวรประจำวันตามหมายเลขโทรศัพท์ที่ระบุ เพื่อขอนัดหมายเวลาเข้าตรวจสอบ</p>
                </div>
                <!-- Step 3 -->
                <div class="step-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm relative overflow-hidden group">
                    <div class="absolute -top-2 -right-2 w-16 h-16 bg-purple-50 rounded-full flex items-center justify-center text-purple-200 font-black text-4xl group-hover:text-purple-100 transition-colors">3</div>
                    <div class="w-12 h-12 bg-purple-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-lg shadow-purple-200">
                        <i class="fa-solid fa-eye text-lg"></i>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-2">ดำเนินการตรวจสอบ</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">เข้าดำเนินการตรวจสอบภาพจากกล้องวงจรปิด ณ ห้องปฏิบัติการ ตามวันและเวลาที่ได้นัดหมายไว้</p>
                </div>
            </div>
            
            <!-- Mobile Admin Link -->
            <div class="mt-8 md:hidden">
                <a href="admin.html" class="text-blue-600 font-bold text-sm underline flex items-center justify-center gap-1">
                    <i class="fa-solid fa-lock"></i> เข้าสู่หน้าจัดการเจ้าหน้าที่
                </a>
            </div>
        </div>

        <div class="max-w-7xl mx-auto grid lg:grid-cols-3 gap-8">
            <!-- Analytics Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-blue-600"></i> สถิติการแจ้งเหตุ
                        </h2>
                        <div class="flex items-center gap-2">
                            <span id="syncStatus" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 uppercase text-center min-w-[80px]">Checking...</span>
                            <button onclick="refreshData()" class="bg-slate-50 hover:bg-slate-100 text-blue-600 p-2 rounded-full transition-colors" title="รีเฟรชข้อมูล">
                                <i class="fa-solid fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container flex-grow" id="chartWrapper">
                        <canvas id="dailyRequestsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Roster Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-3xl border border-slate-200 p-6 h-full shadow-sm overflow-hidden">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 border-b pb-4 flex items-center gap-2">
                        <i class="fa-solid fa-user-shield text-blue-600"></i>
                        <span>ครูเวรประสานงานประจำวัน</span>
                    </h2>
                    <div class="space-y-3 max-h-[500px] overflow-y-auto pr-1" id="roster-list">
                        <!-- Sunday (0) -->
                        <div id="day-0" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-red-200 bg-red-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">อา</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนราศักดิ์ เสาวยงค์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>088-696-3536</p>
                            </div>
                        </div>
                        <!-- Monday (1) -->
                        <div id="day-1" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-yellow-200 bg-yellow-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-yellow-400 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">จ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายธนวิน เกิดประโคน</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>094-356-5879</p>
                            </div>
                        </div>
                        <!-- Tuesday (2) -->
                        <div id="day-2" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-pink-200 bg-pink-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-pink-400 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">อ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายธนวิน เกิดประโคน</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>094-356-5879</p>
                            </div>
                        </div>
                        <!-- Wednesday (3) -->
                        <div id="day-3" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-green-200 bg-green-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">พ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนัตพล ชะเมรัมย์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>065-390-4151</p>
                            </div>
                        </div>
                        <!-- Thursday (4) -->
                        <div id="day-4" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-orange-200 bg-orange-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">พฤ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนัตพล ชะเมรัมย์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>065-390-4151</p>
                            </div>
                        </div>
                        <!-- Friday (5) -->
                        <div id="day-5" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-blue-200 bg-blue-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">ศ</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนราศักดิ์ เสาวยงค์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>088-696-3536</p>
                            </div>
                        </div>
                        <!-- Saturday (6) -->
                        <div id="day-6" class="roster-item p-3 rounded-2xl flex items-center gap-4 border-purple-200 bg-purple-50">
                            <div class="day-icon w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold shadow-sm shrink-0 text-xs">ส</div>
                            <div class="flex-grow">
                                <p class="text-sm font-bold text-slate-800">นายนราศักดิ์ เสาวยงค์</p>
                                <p class="text-xs text-blue-600 font-mono"><i class="fa-solid fa-phone mr-1"></i>088-696-3536</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Form -->
    <div id="requestModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <div class="relative bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all">
                <div class="bg-blue-900 px-6 py-5 flex justify-between items-center text-white">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-file-circle-plus text-xl text-yellow-400"></i>
                        <h3 class="font-bold text-lg">แบบฟอร์มแจ้งเหตุ / ขอดูกล้อง</h3>
                    </div>
                    <button onclick="closeModal()" class="hover:bg-blue-800 p-1 rounded-full transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="p-6 md:p-8 bg-slate-50">
                    <form id="cctvForm" class="space-y-5">
                        <input type="hidden" name="requestId" id="requestIdInput">
                        <input type="hidden" name="submissionDate" id="submissionDateInput">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">ชื่อ-นามสกุล ผู้แจ้ง</label>
                                <input type="text" name="fullName" required placeholder="เช่น นายสมชาย ใจดี" class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">ชั้น / ตำแหน่ง</label>
                                <input type="text" name="position" required placeholder="เช่น ม.6/1" class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">เบอร์โทรศัพท์ติดต่อ</label>
                                <input type="tel" name="phone" required placeholder="08x-xxx-xxxx" class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 ml-1">วันที่ต้องการตรวจสอบ</label>
                                <input type="date" name="targetDate" required class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 ml-1">รายละเอียดเหตุการณ์ / จุดที่ขอดู</label>
                            <textarea name="details" rows="3" required placeholder="อธิบายเหตุการณ์ ช่วงเวลา และจุดที่ต้องการตรวจสอบ..." class="w-full border border-slate-200 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all"></textarea>
                        </div>

                        <button type="submit" id="submitBtn" class="w-full bg-blue-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-blue-800 active:scale-[0.98] transition-all shadow-xl">
                            <span id="btnLoader" class="loader hidden"></span>
                            <span id="btnText">ยืนยันการส่งคำร้อง</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwGYM1bHvyBYFB91O2LOXxPAwXNWUATA7Xqpow2mZ2nUoUO-HoTvxG5TYmDgsBrPk5C9Q/exec'; 
        let myChart;

        async function refreshData() {
            const statusLabel = document.getElementById('syncStatus');
            statusLabel.innerText = "Syncing...";
            statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-blue-100 text-blue-600 uppercase animate-pulse";

            if (!scriptURL || scriptURL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                renderChart(['15 ก.พ.', '16 ก.พ.', '17 ก.พ.'], [2, 5, 3]);
                statusLabel.innerText = "Mock Mode";
                statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-amber-100 text-amber-600 uppercase";
                return;
            }

            try {
                const response = await fetch(`${scriptURL}?action=getStats&t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.result === 'success') {
                    renderChart(data.labels, data.values);
                    statusLabel.innerText = "Connected";
                    statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-green-100 text-green-600 uppercase";
                } else { throw new Error(data.error); }
            } catch (err) {
                statusLabel.innerText = "Sync Failed";
                statusLabel.className = "text-[10px] font-bold px-2 py-1 rounded-full bg-red-100 text-red-600 uppercase";
                renderMockChart();
            }
        }

        function renderChart(labels, values) {
            const ctx = document.getElementById('dailyRequestsChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'จำนวนการแจ้งเหตุ',
                        data: values,
                        backgroundColor: 'rgba(30, 58, 138, 0.85)',
                        borderRadius: 8,
                        maxBarThickness: 45
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderMockChart() {
            renderChart(['15 ก.พ.', '16 ก.พ.', '17 ก.พ.'], [2, 5, 3]);
        }

        function generateId() {
            const lastId = localStorage.getItem('last_np_req_id') || 0;
            const newId = parseInt(lastId) + 1;
            localStorage.setItem('last_np_req_id', newId);
            return 'NP' + String(newId).padStart(4, '0');
        }

        function openModal() {
            document.getElementById('requestModal').classList.remove('hidden');
            document.getElementById('requestIdInput').value = generateId();
            document.getElementById('submissionDateInput').value = new Date().toISOString();
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('requestModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('cctvForm').reset();
        }

        document.getElementById('cctvForm').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const loader = document.getElementById('btnLoader');
            const text = document.getElementById('btnText');

            if (!scriptURL || scriptURL === 'https://script.google.com/macros/s/AKfycbwGYM1bHvyBYFB91O2LOXxPAwXNWUATA7Xqpow2mZ2nUoUO-HoTvxG5TYmDgsBrPk5C9Q/exec') {
                alert('กรุณาตั้งค่า Script URL ก่อนครับ');
                return;
            }

            btn.disabled = true;
            loader.classList.remove('hidden');
            text.innerText = "กำลังส่งข้อมูล...";

            try {
                const response = await fetch(scriptURL, { method: 'POST', body: new FormData(e.target) });
                const result = await response.json();
                if (result.result === 'success') {
                    alert('ส่งคำร้องสำเร็จ!');
                    closeModal();
                    setTimeout(refreshData, 2000); 
                } else { throw new Error(result.error); }
            } catch (err) { alert('เกิดข้อผิดพลาด: ' + err.message); }
            finally {
                btn.disabled = false;
                loader.classList.add('hidden');
                text.innerText = "ยืนยันการส่งคำร้อง";
            }
        });

        function updateRosterHighlight() {
            const today = new Date().getDay(); 
            document.querySelectorAll('.roster-item').forEach(item => {
                const dayId = parseInt(item.id.split('-')[1]);
                if (dayId === today) {
                    item.classList.remove('inactive');
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                    item.classList.add('inactive');
                }
            });
        }

        window.onload = () => {
            updateRosterHighlight();
            refreshData();
        };
    </script>
</body>
</html>


